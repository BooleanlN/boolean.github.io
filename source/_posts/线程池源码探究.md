---
title: çº¿ç¨‹æ± æºç æ¢ç©¶
date: 2021-10-23 13:24:48
tags: [java, é¢è¯•]
---

### çº¿ç¨‹æ± æºç 

#### ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ

1. æé«˜çº¿ç¨‹åˆ©ç”¨ç‡
2. å‡å°‘å› ä¸ºåˆ›å»ºã€é”€æ¯çº¿ç¨‹æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—
3. æé«˜ååé‡

#### å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ

```java
ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor()
```

å¹¶æŒ‡å®šçº¿ç¨‹æ± çš„`corePoolSize`ã€`maximumPoolSize`ã€`keepAliveTime`ã€`unit`ã€`workQueue`ã€`threadFactory`ã€`handler`

#### çº¿ç¨‹æ± æ‰§è¡Œé€»è¾‘ï¼Ÿ

é¦–å…ˆä»‹ç»ä¸‹çº¿ç¨‹æ± å‚æ•°æ¦‚å¿µï¼š

corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± åŸºæœ¬å¤§å°

maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼ŒåŒä¸€æ—¶åˆ»å†…çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡æœ€å¤§é˜ˆå€¼ã€‚

keepAliveTimeï¼šå·¥ä½œçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œè¶…è¿‡è¯¥ç©ºé—²æ—¶é—´ï¼Œå·¥ä½œçº¿ç¨‹å°†ä¼šè¢«å›æ”¶

unitï¼škeepAliveTimeçš„æ—¶é—´å•ä½

wordQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾ä»»åŠ¡ã€‚

threadFactoryï¼šçº¿ç¨‹æ± åˆ›å»ºå·¥å‚ç±»ï¼ˆé»˜è®¤ä¸º`DefaultThreadFactory`ï¼‰

handlerï¼šæ‹’ç»ç­–ç•¥ï¼š

- AbortPolicyï¼šæ‹’ç»ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ˆ**é»˜è®¤ç­–ç•¥**ï¼‰
- CallerRunsPolicyï¼šæäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±å¤„ç†
- DiscardPolicyï¼šä¸å¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ
- DiscardOldestPolicyï¼šä¸¢å¼ƒæ’åœ¨æœ€å‰é¢çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡

#### å…¶å®ƒçº¿ç¨‹æ± ç›¸å…³æœ¯è¯­

1. ThreadFactory

   çº¿ç¨‹å·¥å‚ï¼Œç”¨äºçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹

   - ThreadGroupï¼šçº¿ç¨‹ç»„ï¼Œä¸€ç»„æ–¹ä¾¿ç®¡ç†çš„çº¿ç¨‹é›†åˆï¼Œæ•´ä½“å‘ˆæ ‘å½¢å…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼ˆæ¥æºäºç½‘ç»œï¼‰æ‰€ç¤º

     ![image-20211206160029819](https://tva1.sinaimg.cn/large/008i3skNgy1gx467chs4fj30ns0mmaar.jpg)

   - ThreadName

     çº¿ç¨‹åç§°ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹æ—¶ï¼ŒæŒ‡å®šçº¿ç¨‹åç§°

   - Daemon

     æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹

   - Priority

     çº¿ç¨‹ä¼˜å…ˆçº§

   ä»¥æ¯”è¾ƒå¸¸ç”¨çš„`DefaultThreadFactory`ä¸ºä¾‹ï¼š

   ```java
   static class DefaultThreadFactory implements ThreadFactory {
     			// å¹¶å‘æ§åˆ¶é‡ï¼Œåæ˜ å½“å‰poolä¸­åˆ›å»ºçš„çº¿ç¨‹åç§°æ•°é‡
           private static final AtomicInteger poolNumber = new AtomicInteger(1);
           private final ThreadGroup group;
     			// å¹¶å‘æ§åˆ¶é‡ï¼Œåæ˜ å½“å‰poolä¸­åˆ›å»ºçš„çº¿ç¨‹æ•°é‡
           private final AtomicInteger threadNumber = new AtomicInteger(1);
           private final String namePrefix;
   
           DefaultThreadFactory() {
              // ç³»ç»Ÿå®‰å…¨ç®¡ç†å™¨ï¼Œä¿è¯æ“ä½œçš„å®‰å…¨æ€§
               SecurityManager s = System.getSecurityManager();
               group = (s != null) ? s.getThreadGroup() :
                                     Thread.currentThread().getThreadGroup();
               namePrefix = "pool-" +
                             poolNumber.getAndIncrement() +
                            "-thread-";
           }
   		   // é‡å†™çš„æ–¹æ³•
           public Thread newThread(Runnable r) {
               Thread t = new Thread(group, r,
                                     namePrefix + threadNumber.getAndIncrement(),
                                     0);
             // åˆ›å»ºéå®ˆæŠ¤çº¿ç¨‹  
             if (t.isDaemon())
                   t.setDaemon(false);
             // åˆ›å»ºçº¿ç¨‹ä¼˜å…ˆçº§ä¸ºNORM_PRIORITY
               if (t.getPriority() != Thread.NORM_PRIORITY)
                   t.setPriority(Thread.NORM_PRIORITY);
               return t;
           }
       }
   ```



#### çº¿ç¨‹æ± å®ç°æºç 

1. Workerå·¥ä½œçº¿ç¨‹ç±»

   Workerç±»ç»§æ‰¿äº†AQSï¼Œç›®çš„æ˜¯ç®€åŒ–è·å–å’Œé‡Šæ”¾ä»»åŠ¡æ‰§è¡Œæ—¶æ‰€éœ€é”çš„æ“ä½œã€‚

   åŠ é”çš„åŸå› ï¼š

   1. é˜²æ­¢åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­

```java
private final class Worker
        extends AbstractQueuedSynchronizer
        implements Runnable
{
  // çº¿ç¨‹ï¼Œé»˜è®¤ä¸ºNULLï¼Œfactoryåˆ›å»ºå¤±è´¥ä¹Ÿä¸ºNULL
  final Thread thread;
  // åˆå§‹åŒ–ä»»åŠ¡
  Runnable firstTask;
  // ä»»åŠ¡è®¡æ•°å™¨
  volatile long completedTasks;
  
  Worker(Runnable firstTask) {
    setState(-1); // ç¦æ­¢ä¸­æ–­
    this.firstTask = firstTask;
    this.thread = getThreadFactory().newThread(this);
  }
  // 
  public void run() {runWorker(this);}
  protected boolean isHeldExclusively() {return getState() != 0;}
  // é‡å†™tryAcquireæ–¹æ³•ï¼ŒCASè·å–é”
  protected boolean tryAcquire(int unused) {
    if (compareAndSetState(0, 1)) {
      setExclusiveOwnerThread(Thread.currentThread());
      return true;
    }
    return false;
  }
 // é‡å†™AQS-tryReleaseæ–¹æ³•
  protected boolean tryRelease(int unused) {
    setExclusiveOwnerThread(null);
    setState(0);
    return true;
  }
  // é¦–å…ˆè°ƒç”¨tryAcquireæ–¹æ³•è·å–ğŸ”’ï¼Œè·å–ä¸åˆ°ï¼Œåˆ™åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
  public void lock()        { acquire(1); }
  // è°ƒç”¨tryAcquireæ–¹æ³•è·å–ğŸ”’ï¼Œè·å–ä¸åˆ°ï¼Œè¿”å›false
  public boolean tryLock()  { return tryAcquire(1); }
  // è°ƒç”¨tryReleaseï¼Œå¹¶å”¤é†’åç»­çº¿ç¨‹
  public void unlock()      { release(1); }
  public boolean isLocked() { return isHeldExclusively(); }
  // ä¸­æ–­å½“å‰çº¿ç¨‹
  void interruptIfStarted() {
    Thread t;
    // stateä¸º-1æ—¶ï¼Œä¸å¯ä¸­æ–­
    if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {
      try {
        t.interrupt();
      } catch (SecurityException ignore) {
      }
    }
  }
}
```

æ‰§è¡Œworkerçº¿ç¨‹

```java
final void runWorker(Worker w) {
    Thread wt = Thread.currentThread();
    Runnable task = w.firstTask;
    w.firstTask = null;
    w.unlock(); // allow interrupts
    boolean completedAbruptly = true;
    try {
        while (task != null || (task = getTask()) != null) {
            w.lock();
            // If pool is stopping, ensure thread is interrupted;
            // if not, ensure thread is not interrupted.  This
            // requires a recheck in second case to deal with
            // shutdownNow race while clearing interrupt
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &&
                  runStateAtLeast(ctl.get(), STOP))) &&
                !wt.isInterrupted())
                wt.interrupt();
            try {
                beforeExecute(wt, task);
                Throwable thrown = null;
                try {
                    task.run();
                } catch (RuntimeException x) {
                    thrown = x; throw x;
                } catch (Error x) {
                    thrown = x; throw x;
                } catch (Throwable x) {
                    thrown = x; throw new Error(x);
                } finally {
                    afterExecute(task, thrown);
                }
            } finally {
                task = null;
                w.completedTasks++;
                w.unlock();
            }
        }
        completedAbruptly = false;
    } finally {
        processWorkerExit(w, completedAbruptly);
    }
}
```

2. æ‰§è¡Œæ–¹æ³•`execute`

```java
public void execute(Runnable command) {
  if (command == null)
      throw new NullPointerException();
  int c = ctl.get();
  // 1. å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ— è®ºå½“å‰å…¶å®ƒæ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ç©ºé—²ï¼Œéƒ½åˆ›å»ºæ–°çº¿ç¨‹
  if (workerCountOf(c) < corePoolSize) {
    if (addWorker(command, true))
      return;
    c = ctl.get();
  }
  // 2. å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™æ·»åŠ è‡³é˜»å¡é˜Ÿåˆ—
  if (isRunning(c) && workQueue.offer(command)) {
    int recheck = ctl.get();
    // 2.1 æ·»åŠ æˆåŠŸï¼Œæ£€æµ‹çº¿ç¨‹æ± çŠ¶æ€
    // 2.1.1 çº¿ç¨‹æ± å…³é—­ï¼Œåˆ™ç§»èµ°ä»»åŠ¡ï¼Œèµ°rejectç­–ç•¥
    if (! isRunning(recheck) && remove(command))
      reject(command);
    // 2.1.2 å½“ä¸€ä¸ªworkeréƒ½æ²¡æœ‰æ—¶ï¼Œåˆ™æ·»åŠ worker
    else if (workerCountOf(recheck) == 0)
      addWorker(null, false);
  }
  // 3. é˜Ÿåˆ—æ»¡æ—¶ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœè¶…å‡ºmaximumPoolSizeï¼Œåˆ™rejectç­–ç•¥
  else if (!addWorker(command, false))
    reject(command); 
}
```

![image-20211023141607308](https://tva1.sinaimg.cn/large/008i3skNgy1gvp7x6wdp4j61qi0s8whx02.jpg)



