<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><title>çº¿ç¨‹æ± æºç æ¢ç©¶ â”‚ Boolean</title><link rel="stylesheet" href="/myblog/css/oasis.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/myblog/atom.xml" title="Boolean" type="application/atom+xml">
</head><body><div id="content"><h1 id="title">çº¿ç¨‹æ± æºç æ¢ç©¶</h1><div id="menu-outer"><nav id="menu-inner"><a id="menu-back" href="javascript:history.back()">Back</a><time datetime="2021-10-23T05:24:48.000Z">2021-10-23</time></nav></div><div id="content-outer"><div id="content-inner"><article id="post"><h3 id="çº¿ç¨‹æ± æºç "><a href="#çº¿ç¨‹æ± æºç " class="headerlink" title="çº¿ç¨‹æ± æºç "></a>çº¿ç¨‹æ± æºç </h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ</h4><ol>
<li>æé«˜çº¿ç¨‹åˆ©ç”¨ç‡</li>
<li>å‡å°‘å› ä¸ºåˆ›å»ºã€é”€æ¯çº¿ç¨‹æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—</li>
<li>æé«˜ååé‡</li>
</ol>
<h4 id="å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ"><a href="#å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ"></a>å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¹¶æŒ‡å®šçº¿ç¨‹æ± çš„<code>corePoolSize</code>ã€<code>maximumPoolSize</code>ã€<code>keepAliveTime</code>ã€<code>unit</code>ã€<code>workQueue</code>ã€<code>threadFactory</code>ã€<code>handler</code></p>
<h4 id="çº¿ç¨‹æ± æ‰§è¡Œé€»è¾‘ï¼Ÿ"><a href="#çº¿ç¨‹æ± æ‰§è¡Œé€»è¾‘ï¼Ÿ" class="headerlink" title="çº¿ç¨‹æ± æ‰§è¡Œé€»è¾‘ï¼Ÿ"></a>çº¿ç¨‹æ± æ‰§è¡Œé€»è¾‘ï¼Ÿ</h4><p>é¦–å…ˆä»‹ç»ä¸‹çº¿ç¨‹æ± å‚æ•°æ¦‚å¿µï¼š</p>
<p>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± åŸºæœ¬å¤§å°</p>
<p>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼ŒåŒä¸€æ—¶åˆ»å†…çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡æœ€å¤§é˜ˆå€¼ã€‚</p>
<p>keepAliveTimeï¼šå·¥ä½œçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œè¶…è¿‡è¯¥ç©ºé—²æ—¶é—´ï¼Œå·¥ä½œçº¿ç¨‹å°†ä¼šè¢«å›æ”¶</p>
<p>unitï¼škeepAliveTimeçš„æ—¶é—´å•ä½</p>
<p>wordQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾ä»»åŠ¡ã€‚</p>
<p>threadFactoryï¼šçº¿ç¨‹æ± åˆ›å»ºå·¥å‚ç±»ï¼ˆé»˜è®¤ä¸º<code>DefaultThreadFactory</code>ï¼‰</p>
<p>handlerï¼šæ‹’ç»ç­–ç•¥ï¼š</p>
<ul>
<li>AbortPolicyï¼šæ‹’ç»ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ˆ<strong>é»˜è®¤ç­–ç•¥</strong>ï¼‰</li>
<li>CallerRunsPolicyï¼šæäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±å¤„ç†</li>
<li>DiscardPolicyï¼šä¸å¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ</li>
<li>DiscardOldestPolicyï¼šä¸¢å¼ƒæ’åœ¨æœ€å‰é¢çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</li>
</ul>
<h4 id="å…¶å®ƒçº¿ç¨‹æ± ç›¸å…³æœ¯è¯­"><a href="#å…¶å®ƒçº¿ç¨‹æ± ç›¸å…³æœ¯è¯­" class="headerlink" title="å…¶å®ƒçº¿ç¨‹æ± ç›¸å…³æœ¯è¯­"></a>å…¶å®ƒçº¿ç¨‹æ± ç›¸å…³æœ¯è¯­</h4><ol>
<li><p>ThreadFactory</p>
<p>çº¿ç¨‹å·¥å‚ï¼Œç”¨äºçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹</p>
<ul>
<li><p>ThreadGroupï¼šçº¿ç¨‹ç»„ï¼Œä¸€ç»„æ–¹ä¾¿ç®¡ç†çš„çº¿ç¨‹é›†åˆï¼Œæ•´ä½“å‘ˆæ ‘å½¢å…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼ˆæ¥æºäºç½‘ç»œï¼‰æ‰€ç¤º</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx467chs4fj30ns0mmaar.jpg" alt="image-20211206160029819"></p>
</li>
<li><p>ThreadName</p>
<p>çº¿ç¨‹åç§°ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹æ—¶ï¼ŒæŒ‡å®šçº¿ç¨‹åç§°</p>
</li>
<li><p>Daemon</p>
<p>æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹</p>
</li>
<li><p>Priority</p>
<p>çº¿ç¨‹ä¼˜å…ˆçº§</p>
</li>
</ul>
<p>ä»¥æ¯”è¾ƒå¸¸ç”¨çš„<code>DefaultThreadFactory</code>ä¸ºä¾‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DefaultThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">&#123;</span>
  			<span class="token comment">// å¹¶å‘æ§åˆ¶é‡ï¼Œåæ˜ å½“å‰poolä¸­åˆ›å»ºçš„çº¿ç¨‹åç§°æ•°é‡</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> poolNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadGroup</span> group<span class="token punctuation">;</span>
  			<span class="token comment">// å¹¶å‘æ§åˆ¶é‡ï¼Œåæ˜ å½“å‰poolä¸­åˆ›å»ºçš„çº¿ç¨‹æ•°é‡</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> threadNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namePrefix<span class="token punctuation">;</span>

        <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">// ç³»ç»Ÿå®‰å…¨ç®¡ç†å™¨ï¼Œä¿è¯æ“ä½œçš„å®‰å…¨æ€§</span>
            <span class="token class-name">SecurityManager</span> s <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            group <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                                  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            namePrefix <span class="token operator">=</span> <span class="token string">"pool-"</span> <span class="token operator">+</span>
                          poolNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                         <span class="token string">"-thread-"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
		   <span class="token comment">// é‡å†™çš„æ–¹æ³•</span>
        <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> r<span class="token punctuation">,</span>
                                  namePrefix <span class="token operator">+</span> threadNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// åˆ›å»ºéå®ˆæŠ¤çº¿ç¨‹  </span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// åˆ›å»ºçº¿ç¨‹ä¼˜å…ˆçº§ä¸ºNORM_PRIORITY</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">)</span>
                t<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h4 id="çº¿ç¨‹æ± å®ç°æºç "><a href="#çº¿ç¨‹æ± å®ç°æºç " class="headerlink" title="çº¿ç¨‹æ± å®ç°æºç "></a>çº¿ç¨‹æ± å®ç°æºç </h4><ol>
<li><p>Workerå·¥ä½œçº¿ç¨‹ç±»</p>
<p>Workerç±»ç»§æ‰¿äº†AQSï¼Œç›®çš„æ˜¯ç®€åŒ–è·å–å’Œé‡Šæ”¾ä»»åŠ¡æ‰§è¡Œæ—¶æ‰€éœ€é”çš„æ“ä½œã€‚</p>
<p>åŠ é”çš„åŸå› ï¼š</p>
<ol>
<li>é˜²æ­¢åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
        <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// çº¿ç¨‹ï¼Œé»˜è®¤ä¸ºNULLï¼Œfactoryåˆ›å»ºå¤±è´¥ä¹Ÿä¸ºNULL</span>
  <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
  <span class="token comment">// åˆå§‹åŒ–ä»»åŠ¡</span>
  <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>
  <span class="token comment">// ä»»åŠ¡è®¡æ•°å™¨</span>
  <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>
  
  <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¦æ­¢ä¸­æ–­</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// </span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
  <span class="token comment">// é‡å†™tryAcquireæ–¹æ³•ï¼ŒCASè·å–é”</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token comment">// é‡å†™AQS-tryReleaseæ–¹æ³•</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// é¦–å…ˆè°ƒç”¨tryAcquireæ–¹æ³•è·å–ğŸ”’ï¼Œè·å–ä¸åˆ°ï¼Œåˆ™åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token comment">// è°ƒç”¨tryAcquireæ–¹æ³•è·å–ğŸ”’ï¼Œè·å–ä¸åˆ°ï¼Œè¿”å›false</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token comment">// è°ƒç”¨tryReleaseï¼Œå¹¶å”¤é†’åç»­çº¿ç¨‹</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token comment">// ä¸­æ–­å½“å‰çº¿ç¨‹</span>
  <span class="token keyword">void</span> <span class="token function">interruptIfStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
    <span class="token comment">// stateä¸º-1æ—¶ï¼Œä¸å¯ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰§è¡Œworkerçº¿ç¨‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>
    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allow interrupts</span>
    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If pool is stopping, ensure thread is interrupted;</span>
            <span class="token comment">// if not, ensure thread is not interrupted.  This</span>
            <span class="token comment">// requires a recheck in second case to deal with</span>
            <span class="token comment">// shutdownNow race while clearing interrupt</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span>
                 <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                  <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>æ‰§è¡Œæ–¹æ³•<code>execute</code></li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1. å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ— è®ºå½“å‰å…¶å®ƒæ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ç©ºé—²ï¼Œéƒ½åˆ›å»ºæ–°çº¿ç¨‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 2. å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™æ·»åŠ è‡³é˜»å¡é˜Ÿåˆ—</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.1 æ·»åŠ æˆåŠŸï¼Œæ£€æµ‹çº¿ç¨‹æ± çŠ¶æ€</span>
    <span class="token comment">// 2.1.1 çº¿ç¨‹æ± å…³é—­ï¼Œåˆ™ç§»èµ°ä»»åŠ¡ï¼Œèµ°rejectç­–ç•¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.1.2 å½“ä¸€ä¸ªworkeréƒ½æ²¡æœ‰æ—¶ï¼Œåˆ™æ·»åŠ worker</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 3. é˜Ÿåˆ—æ»¡æ—¶ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœè¶…å‡ºmaximumPoolSizeï¼Œåˆ™rejectç­–ç•¥</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvp7x6wdp4j61qi0s8whx02.jpg" alt="image-20211023141607308"></p>
<div class="post-tags"><a class="post-tag-link" href="/myblog/tags/java/" rel="tag">#java</a>, <a class="post-tag-link" href="/myblog/tags/%E9%9D%A2%E8%AF%95/" rel="tag">#é¢è¯•</a></div></article><div id="paginator"></div></div></div><div id="bottom-outer"><div id="bottom-inner"><hr><div><div><a>2022@ </a><a href="/atom.xml"><img src="/assets/rss.png"></a></div><div id="hexo"><a>Powered by&nbsp</a><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><a>&nbsp&&nbsp</a><a target="_blank" rel="noopener" href="https://github.com/qiantao94/hexo-theme-oasis">Oasis</a></div></div></div></div></div></body><script src="/myblog/js/oasis.js"></script></html>